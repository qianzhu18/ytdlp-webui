å¤ªæ£’äº†ï¼æ—¢ç„¶ UIï¼ˆâ€œçš®å›Šâ€ï¼‰å·²ç»å‡çº§å®Œæ¯•ï¼Œç°åœ¨æˆ‘ä»¬æ¥ä¸ºå®ƒæ³¨å…¥â€œçµé­‚â€ã€‚

è¿™æ˜¯**Local Video Downloader 2.0 çš„åŠŸèƒ½æ ¸å¿ƒå‡çº§æ–‡æ¡£**ã€‚

è¿™ä»½æ–‡æ¡£å°†æ›¿æ¢åŸæœ‰çš„åç«¯é€»è¾‘ï¼ˆ`app.py`ï¼‰å’Œå‰ç«¯äº¤äº’ï¼ˆ`app.js`ï¼‰ï¼Œå®ç°ä»¥ä¸‹æ ¸å¿ƒè´¨å˜ï¼š

1. **æ‰¹é‡ä¸‹è½½**ï¼šæ”¯æŒä¸€æ¬¡æ€§ç²˜è´´å¤šè¡Œé“¾æ¥ï¼Œè‡ªåŠ¨åˆ†æ‹†ä»»åŠ¡ã€‚
2. **å¹¶å‘æ§åˆ¶**ï¼šå¼•å…¥çº¿ç¨‹æ± ï¼Œé»˜è®¤åŒæ—¶ä¸‹è½½ 2 ä¸ªä»»åŠ¡ï¼Œå…¶ä½™æ’é˜Ÿï¼Œé˜²æ­¢ Docker å´©æºƒã€‚
3. **ä»»åŠ¡é˜Ÿåˆ—**ï¼šä»â€œå•ä»»åŠ¡ç›‘æ§â€å˜ä¸ºâ€œä»»åŠ¡åˆ—è¡¨çœ‹æ¿â€ã€‚
4. **æŒä¹…åŒ–/å†å²è®°å½•**ï¼ˆè½»é‡çº§ï¼‰ï¼šè™½ç„¶æš‚ä¸ä¸Šæ•°æ®åº“ï¼Œä½†ä¼šåœ¨å†…å­˜ä¸­ä¿ç•™æœ€è¿‘çš„ä»»åŠ¡è®°å½•ä¾›æŸ¥çœ‹ã€‚

---

### ğŸ› ï¸ ç¬¬ä¸€æ­¥ï¼šåç«¯æ ¸å¿ƒé‡æ„ (`webui/app.py`)

**ä¸»è¦æ”¹åŠ¨**ï¼š

* å¼•å…¥ `ThreadPoolExecutor` ç®¡ç†å¹¶å‘ã€‚
* é‡å†™ `/api/start` ä»¥å¤„ç†å¤šè¡Œæ–‡æœ¬ã€‚
* æ–°å¢ `/api/tasks` æ¥å£ä¾›å‰ç«¯è½®è¯¢åˆ—è¡¨ã€‚

è¯·å®Œå…¨æ›¿æ¢ `webui/app.py` çš„å†…å®¹ï¼š

```python
import json
import os
import threading
import time
import uuid
from dataclasses import dataclass, field
from pathlib import Path
from concurrent.futures import ThreadPoolExecutor

from flask import Flask, abort, jsonify, render_template, request, send_from_directory

try:
    import yt_dlp
except ImportError as exc:
    raise SystemExit("yt-dlp is not installed. Run: pip install yt-dlp") from exc

APP_TITLE = "Local Video Downloader"
DOWNLOAD_DIR = os.environ.get("DOWNLOAD_DIR", "/downloads")
COOKIES_PATH = os.environ.get("COOKIES_PATH", "")
# é»˜è®¤ 2 ä¸ªå¹¶å‘ï¼Œé˜²æ­¢å†…å­˜çˆ†ç‚¸
MAX_WORKERS = int(os.environ.get("MAX_WORKERS", "2"))
HOST = os.environ.get("HOST", "0.0.0.0")
PORT = int(os.environ.get("PORT", "8080"))

# æ‰©å±•äº†é¢„è®¾ï¼Œå¢åŠ  4K å’Œ çº¯éŸ³é¢‘
FORMAT_PRESETS = {
    "Video (Best MP4)": {
        "format": "bestvideo+bestaudio/best",
        "merge_output_format": "mp4",
    },
    "Video (4K/High Res)": {
        "format": "bestvideo[height>1080]+bestaudio/best",
        "merge_output_format": "mp4",
    },
    "Video (1080p MP4)": {
        "format": "bestvideo[height<=1080]+bestaudio/best[height<=1080]/best",
        "merge_output_format": "mp4",
    },
    "Audio (MP3 Best)": {
        "format": "bestaudio/best",
        "postprocessors": [
            {
                "key": "FFmpegExtractAudio",
                "preferredcodec": "mp3",
                "preferredquality": "192",
            }
        ],
    },
}

@dataclass
class Job:
    job_id: str
    url: str
    preset: str
    use_cookies: bool
    created_at: float = field(default_factory=time.time)
    progress: float = 0.0
    status: str = "Queued"  # åˆå§‹çŠ¶æ€ä¸ºæ’é˜Ÿ
    done: bool = False
    success: bool = False
    error: str | None = None
    title: str | None = None # æ–°å¢ï¼šä¿å­˜è§†é¢‘æ ‡é¢˜
    lock: threading.Lock = field(default_factory=threading.Lock, repr=False)

app = Flask(__name__)
jobs: dict[str, Job] = {}
jobs_lock = threading.Lock()
executor = ThreadPoolExecutor(max_workers=MAX_WORKERS)

# --- å·¥å…·å‡½æ•° ---

class JobLogger:
    def __init__(self, job: Job):
        self.job = job

    def debug(self, msg): pass
    def info(self, msg): pass
    def warning(self, msg): pass
    def error(self, msg):
        # yt-dlp çš„ error ä¹Ÿä¼šåœ¨ except ä¸­æ•è·ï¼Œè¿™é‡Œä¸»è¦ç”¨äºæ—¥å¿—æ‰“å°
        print(f"[{self.job.job_id}] Error: {msg}")

def make_progress_hook(job: Job):
    def hook(data):
        if data['status'] == 'downloading':
            total = data.get('total_bytes') or data.get('total_bytes_estimate')
            downloaded = data.get('downloaded_bytes')
            
            with job.lock:
                if total and downloaded:
                    job.progress = (downloaded / total) * 100
                
                # å°è¯•è·å–æ–‡ä»¶åæˆ–æ ‡é¢˜
                if not job.title and data.get('info_dict'):
                    job.title = data['info_dict'].get('title')

                percent = data.get('_percent_str', '').strip()
                speed = data.get('_speed_str', '').strip()
                job.status = f"Downloading {percent} ({speed})"

        elif data['status'] == 'finished':
            with job.lock:
                job.progress = 100
                job.status = "Processing..."
    return hook

def download_task(job_id: str):
    """çº¿ç¨‹æ± æ‰§è¡Œçš„ä¸‹è½½ä»»åŠ¡"""
    job = jobs.get(job_id)
    if not job: return

    with job.lock:
        job.status = "Starting..."
    
    # æ„å»º yt-dlp é€‰é¡¹
    preset_conf = FORMAT_PRESETS.get(job.preset, FORMAT_PRESETS["Video (Best MP4)"])
    options = {
        "format": preset_conf["format"],
        "outtmpl": str(Path(DOWNLOAD_DIR) / "%(title)s.%(ext)s"),
        "logger": JobLogger(job),
        "progress_hooks": [make_progress_hook(job)],
        # å¾ˆå¤šæ—¶å€™ cookies è·¯å¾„ä¸æ­£ç¡®ä¼šå¯¼è‡´ crashï¼Œè¿™é‡Œåšä¸ªå®¹é”™
        "ignoreerrors": True, 
        "no_warnings": True,
    }
    
    if preset_conf.get("merge_output_format"):
        options["merge_output_format"] = preset_conf["merge_output_format"]
    if preset_conf.get("postprocessors"):
        options["postprocessors"] = preset_conf["postprocessors"]
    
    if job.use_cookies and COOKIES_PATH and Path(COOKIES_PATH).is_file():
        options["cookiefile"] = COOKIES_PATH

    try:
        Path(DOWNLOAD_DIR).mkdir(parents=True, exist_ok=True)
        with yt_dlp.YoutubeDL(options) as ydl:
            # æå–ä¿¡æ¯ä»¥è·å–æ ‡é¢˜ï¼ˆå¿«é€Ÿï¼‰
            try:
                info = ydl.extract_info(job.url, download=False)
                with job.lock:
                    job.title = info.get('title', 'Unknown Title')
            except:
                pass 
            
            # å¼€å§‹ä¸‹è½½
            ydl.download([job.url])
            
        with job.lock:
            job.status = "Completed"
            job.done = True
            job.success = True
            job.progress = 100
    except Exception as e:
        with job.lock:
            job.status = "Failed"
            job.done = True
            job.success = False
            job.error = str(e)

# --- è·¯ç”± ---

@app.route("/")
def index():
    config = {
        "presets": list(FORMAT_PRESETS.keys()),
        "defaultPreset": list(FORMAT_PRESETS.keys())[0],
    }
    return render_template("index.html", app_title=APP_TITLE, config_json=json.dumps(config))

@app.route("/api/start", methods=["POST"])
def api_start():
    data = request.get_json(silent=True) or {}
    raw_urls = data.get("url", "")
    preset = data.get("preset", "")
    use_cookies = bool(data.get("use_cookies"))

    # æŒ‰è¡Œåˆ†å‰²å¹¶å»é‡
    url_list = [line.strip() for line in raw_urls.splitlines() if line.strip()]
    
    if not url_list:
        return jsonify({"error": "No URL provided"}), 400

    created_ids = []
    with jobs_lock:
        for url in url_list:
            job_id = uuid.uuid4().hex
            job = Job(job_id=job_id, url=url, preset=preset, use_cookies=use_cookies)
            jobs[job_id] = job
            # æäº¤åˆ°çº¿ç¨‹æ± 
            executor.submit(download_task, job_id)
            created_ids.append(job_id)

    return jsonify({"message": "Tasks started", "count": len(created_ids)})

@app.route("/api/tasks")
def api_tasks():
    """è·å–æœ€è¿‘çš„ä»»åŠ¡åˆ—è¡¨ï¼ˆUI è½®è¯¢ç”¨ï¼‰"""
    with jobs_lock:
        # æŒ‰æ—¶é—´å€’åºï¼Œåªå–æœ€è¿‘ 50 æ¡
        all_jobs = sorted(jobs.values(), key=lambda x: x.created_at, reverse=True)[:50]
        
        task_list = []
        for j in all_jobs:
            task_list.append({
                "id": j.job_id,
                "url": j.url,
                "title": j.title or j.url, # å¦‚æœæœ‰æ ‡é¢˜æ˜¾ç¤ºæ ‡é¢˜
                "status": j.status,
                "progress": round(j.progress, 1),
                "done": j.done,
                "success": j.success,
                "error": j.error
            })
            
    return jsonify({"tasks": task_list})

@app.route("/api/files")
def api_files():
    """åˆ—å‡ºä¸‹è½½ç›®å½•æ–‡ä»¶"""
    base = Path(DOWNLOAD_DIR)
    if not base.exists(): return jsonify({"files": []})
    
    files = []
    for item in base.iterdir():
        if item.is_file() and not item.name.startswith("."):
            stat = item.stat()
            files.append({
                "name": item.name,
                "size": stat.st_size,
                "mtime": stat.st_mtime
            })
    files.sort(key=lambda x: x["mtime"], reverse=True)
    return jsonify({"files": files})

@app.route("/download/<path:filename>")
def download_file(filename):
    return send_from_directory(DOWNLOAD_DIR, filename, as_attachment=True)

if __name__ == "__main__":
    app.run(host=HOST, port=PORT, threaded=True)

```

---

### ğŸ› ï¸ ç¬¬äºŒæ­¥ï¼šå‰ç«¯é€»è¾‘é€‚é… (`webui/static/app.js`)

**ä¸»è¦æ”¹åŠ¨**ï¼š

* **ç§»é™¤**æ—§çš„å•ä»»åŠ¡è½®è¯¢ (`pollStatus`, `activeJobId`)ã€‚
* **æ–°å¢** `pollTasks`ï¼šæ¯ç§’æ‹‰å–ä¸€æ¬¡ `/api/tasks`ï¼Œå¹¶åŠ¨æ€ç”Ÿæˆåˆ—è¡¨ã€‚
* **äº¤äº’ç®€åŒ–**ï¼šç‚¹å‡»ä¸‹è½½åï¼Œåªæ˜¯æ¸…ç©ºè¾“å…¥æ¡†å¹¶æç¤ºâ€œä»»åŠ¡å·²æ·»åŠ â€ï¼Œå‰©ä¸‹çš„äº¤ç»™åˆ—è¡¨å±•ç¤ºã€‚

è¯·å®Œå…¨æ›¿æ¢ `webui/static/app.js` çš„å†…å®¹ï¼š

```javascript
const config = window.APP_CONFIG || {};

// DOM Elements
const form = document.getElementById("download-form");
const urlInput = document.getElementById("url"); // æ³¨æ„ï¼šåœ¨ index.html éœ€æ”¹ä¸º textarea
const presetSelect = document.getElementById("preset");
const startButton = document.getElementById("start-btn");
const taskListEl = document.getElementById("task-list"); // æ–°å¢ï¼šä»»åŠ¡åˆ—è¡¨å®¹å™¨
const filesListEl = document.getElementById("files-list");
const refreshFilesBtn = document.getElementById("refresh-files");

// State
let pollTimer = null;

function init() {
  // åˆå§‹åŒ–ä¸‹æ‹‰èœå•
  const presets = config.presets || [];
  presets.forEach((preset) => {
    const option = document.createElement("option");
    option.value = preset;
    option.textContent = preset;
    presetSelect.appendChild(option);
  });
  if (config.defaultPreset) presetSelect.value = config.defaultPreset;

  // å¯åŠ¨è½®è¯¢
  startPolling();
  refreshFiles();
}

// --- æ ¸å¿ƒé€»è¾‘ï¼šæäº¤ä»»åŠ¡ ---

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const rawUrls = urlInput.value.trim();
  if (!rawUrls) return;

  // UI ç®€å•çš„åé¦ˆ
  const originalText = startButton.textContent;
  startButton.disabled = true;
  startButton.textContent = "æäº¤ä¸­...";

  try {
    const res = await fetch("/api/start", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        url: rawUrls,
        preset: presetSelect.value,
        use_cookies: document.getElementById("use-cookies")?.checked || false,
      }),
    });

    if (res.ok) {
      // æäº¤æˆåŠŸï¼šæ¸…ç©ºè¾“å…¥ï¼Œç«‹å³åˆ·æ–°åˆ—è¡¨
      urlInput.value = "";
      pollTasks(); 
    } else {
      alert("æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è¾“å…¥");
    }
  } catch (err) {
    console.error(err);
    alert("ç½‘ç»œé”™è¯¯");
  } finally {
    startButton.disabled = false;
    startButton.textContent = originalText;
  }
});

// --- æ ¸å¿ƒé€»è¾‘ï¼šä»»åŠ¡åˆ—è¡¨æ¸²æŸ“ ---

async function pollTasks() {
  try {
    const res = await fetch("/api/tasks");
    if (!res.ok) return;
    const data = await res.json();
    renderTasks(data.tasks || []);
    
    // å¦‚æœæœ‰ä»»åŠ¡åˆšåˆšå®Œæˆï¼Œåˆ·æ–°ä¸€ä¸‹æ–‡ä»¶åˆ—è¡¨
    const hasJustFinished = data.tasks.some(t => t.done && t.progress === 100);
    if (hasJustFinished) {
        // ç®€å•çš„é˜²æŠ–åŠ¨é€»è¾‘å¯ä»¥åœ¨è¿™é‡ŒåŠ ï¼Œæˆ–è€…ä¾èµ–ç”¨æˆ·çš„â€œåˆ·æ–°â€æŒ‰é’®
        // è¿™é‡Œé€‰æ‹©ä¸åšè‡ªåŠ¨åˆ·æ–°æ–‡ä»¶ï¼Œä»¥å…æ‰“æ‰°ç”¨æˆ·ï¼Œè®©ç”¨æˆ·çœ‹çŠ¶æ€å˜ç»¿å³å¯
    }
  } catch (e) {
    console.warn("Poll failed", e);
  }
}

function renderTasks(tasks) {
  if (tasks.length === 0) {
    taskListEl.innerHTML = `<div style="text-align:center; color:#999; padding:20px; font-size:0.9rem;">æš‚æ— æ´»åŠ¨ä»»åŠ¡</div>`;
    return;
  }

  // ç®€å•çš„ Diff é€»è¾‘ï¼šè¿™é‡Œç›´æ¥å…¨é‡é‡ç»˜ï¼Œæ€§èƒ½å¯¹äºå‡ åä¸ªä»»åŠ¡ä¸æ˜¯é—®é¢˜
  taskListEl.innerHTML = tasks.map(task => {
    const isError = task.status === "Failed";
    const isDone = task.done && task.success;
    
    // çŠ¶æ€é¢œè‰²ç±»
    let statusColor = "var(--accent)"; // é»˜è®¤ç»¿è‰²/ç«¹é’
    if (isError) statusColor = "#d32f2f"; // çº¢è‰²
    if (isDone) statusColor = "#999"; // å®Œæˆå˜ç°

    // è¿›åº¦æ¡æ ·å¼
    const progressStyle = `
      width: ${task.progress}%; 
      background-color: ${isError ? '#ef5350' : 'var(--accent)'};
      opacity: ${isDone ? '0.5' : '1'};
    `;

    return `
      <li class="task-item" style="padding: 12px; border-bottom: 1px solid var(--border); position: relative;">
        <div style="display:flex; justify-content:space-between; margin-bottom: 6px;">
          <div style="font-weight:500; font-size:0.9rem; max-width:70%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${task.title || task.url}">
            ${task.title || task.url}
          </div>
          <div style="font-size:0.8rem; color:${statusColor}; font-family:monospace;">
            ${task.status}
          </div>
        </div>
        <div style="height:4px; background:#f0f0f0; border-radius:2px; overflow:hidden;">
          <div style="height:100%; transition: width 0.3s; ${progressStyle}"></div>
        </div>
        ${isError ? `<div style="font-size:0.75rem; color:#d32f2f; margin-top:4px;">${task.error}</div>` : ''}
      </li>
    `;
  }).join("");
}

function startPolling() {
  pollTasks(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
  pollTimer = setInterval(pollTasks, 2000); // æ¯2ç§’åˆ·æ–°
}

// --- æ–‡ä»¶åˆ—è¡¨é€»è¾‘ ---

function formatBytes(bytes) {
  if (bytes === 0) return "0 B";
  const k = 1024;
  const sizes = ["B", "KB", "MB", "GB"];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
}

async function refreshFiles() {
  try {
    const res = await fetch("/api/files");
    const data = await res.json();
    renderFiles(data.files || []);
  } catch (e) {
    console.error(e);
  }
}

function renderFiles(files) {
  if (files.length === 0) {
    filesListEl.innerHTML = `<div style="padding:16px; text-align:center; color:#999; font-size:0.9rem;">ä¸‹è½½ç›®å½•ä¸ºç©º</div>`;
    return;
  }
  filesListEl.innerHTML = files.map(file => `
    <div class="file-item" style="padding:12px; background:var(--bg-page); border-radius:6px; display:flex; justify-content:space-between; align-items:center;">
      <div style="overflow:hidden;">
        <div style="font-weight:500; font-size:0.9rem; margin-bottom:2px;">${file.name}</div>
        <div style="font-size:0.75rem; color:#999;">${formatBytes(file.size)}</div>
      </div>
      <a href="/download/${encodeURIComponent(file.name)}" download style="color:var(--accent); text-decoration:none; font-size:0.85rem; padding:4px 8px; border:1px solid var(--border); border-radius:4px;">ä¸‹è½½</a>
    </div>
  `).join("");
}

if(refreshFilesBtn) refreshFilesBtn.addEventListener("click", refreshFiles);

// Init
init();

```

---

### âš ï¸ ç¬¬ä¸‰æ­¥ï¼šå…³é”®çš„ HTML ç»“æ„æ£€æŸ¥

ä¸ºäº†è®©ä¸Šé¢çš„ JS æ­£å¸¸å·¥ä½œï¼Œä½ éœ€è¦ç¡®è®¤ä½ çš„ `index.html` é‡ŒåŒ…å«ä»¥ä¸‹ ID çš„å…ƒç´ ï¼ˆç‰¹åˆ«æ˜¯**æŠŠè¾“å…¥æ¡†æ”¹ä¸º textarea** å’Œ **æ·»åŠ ä»»åŠ¡åˆ—è¡¨å®¹å™¨**ï¼‰ã€‚

åœ¨ `webui/templates/index.html` ä¸­ï¼š

1. **è¾“å…¥æ¡†ä¿®æ”¹**ï¼šæ‰¾åˆ° `<input type="url" id="url" ...>`ï¼Œæ›¿æ¢ä¸ºï¼š
```html
<textarea 
  id="url" 
  name="url" 
  placeholder="ç²˜è´´è§†é¢‘é“¾æ¥ï¼Œæ”¯æŒæ‰¹é‡ä¸‹è½½ï¼ˆä¸€è¡Œä¸€ä¸ªï¼‰..." 
  rows="4" 
  style="width:100%; padding:10px; border:1px solid var(--border); border-radius:var(--radius); font-family:var(--font-sans); resize:vertical;"
></textarea>

```


2. **æ·»åŠ ä»»åŠ¡åˆ—è¡¨å®¹å™¨**ï¼šåœ¨â€œæäº¤æŒ‰é’®â€ä¸‹æ–¹ï¼Œæˆ–æ–°å»ºä¸€ä¸ªå¡ç‰‡åŒºåŸŸï¼Œæ·»åŠ ï¼š
```html
<section class="card" style="margin-top: 24px;">
  <div class="card-title">
    <h2>ä»»åŠ¡é˜Ÿåˆ—</h2>
  </div>
  <ul id="task-list" style="list-style:none; padding:0; margin:0;">
    </ul>
</section>

```



### ğŸš€ å‡çº§æ€»ç»“

è¿™æ¬¡å‡çº§å®Œæˆåï¼Œä½ çš„å·¥å…·é€»è¾‘å°†å‘ç”Ÿå¦‚ä¸‹å˜åŒ–ï¼š

1. **æäº¤**ï¼šç”¨æˆ·ç²˜è´´ 5 ä¸ªé“¾æ¥ -> ç‚¹å‡»å¼€å§‹ -> å‰ç«¯å‘é€ 1 æ¬¡è¯·æ±‚ -> åç«¯åˆ›å»º 5 ä¸ª Job -> 2 ä¸ªç«‹å³å¼€å§‹ï¼Œ3 ä¸ªçŠ¶æ€ä¸º "Queued"ã€‚
2. **ç›‘æ§**ï¼šå‰ç«¯æ¯ 2 ç§’è½®è¯¢ä»»åŠ¡åˆ—è¡¨ï¼Œä½ ä¼šçœ‹åˆ° 2 ä¸ªè¿›åº¦æ¡åœ¨åŠ¨ï¼Œå…¶ä»–æ˜¾ç¤º "Queued"ã€‚
3. **å®Œæˆ**ï¼šå½“å‰é¢çš„ä»»åŠ¡å®Œæˆåï¼Œçº¿ç¨‹æ± è‡ªåŠ¨é‡Šæ”¾ Workerï¼Œæ’é˜Ÿçš„ä»»åŠ¡è‡ªåŠ¨å˜ä¸º "Starting..."ã€‚

ä¸éœ€è¦é‡å¯ Docker å®¹å™¨ï¼ˆå¦‚æœæ˜¯æŒ‚è½½çš„ä»£ç ï¼‰ï¼Œåªéœ€åˆ·æ–°æµè§ˆå™¨å³å¯ä½“éªŒã€‚